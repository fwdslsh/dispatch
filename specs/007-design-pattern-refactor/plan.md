# Implementation Plan: Architecture Refactoring (Simplified Approach)

**Branch**: `007-design-pattern-refactor` | **Date**: 2025-10-05 | **Spec**: [spec.md](./spec.md)

## Summary

**Primary Requirement**: Refactor Dispatch architecture using **simple ES6 modules and Svelte context API** - NO complex DI frameworks.

**Key Simplification** (per updated spec FR-005): Use organized imports and Svelte `setContext`/`getContext` instead of dependency injection containers.

**Technical Approach**:
1. Create `services.js` factory function that wires dependencies explicitly
2. Replace global singletons with clean ES6 exports
3. Use Svelte context API for client-side service sharing
4. Decompose DatabaseManager into focused repositories
5. Split RunSessionManager into smaller components
6. Organize Socket.IO handlers with middleware
7. Create BaseTunnelManager abstract class
8. Implement JWT using jsonwebtoken (only new dependency)

## Technical Context

**Language/Version**: Node.js 22+ (JavaScript/ESNext with JSDoc), Svelte 5 (client-side)
**Primary Dependencies**:
- **Server**: SvelteKit 2.x, Socket.IO 4.8.x, SQLite3 5.1.7, node-pty, **jsonwebtoken (NEW - only addition)**
- **Client**: Svelte 5 (runes), @battlefieldduck/xterm-svelte, Socket.IO client
- **Testing**: Vitest (unit), Playwright (E2E)

**Storage**: SQLite 3 with event sourcing
**Testing**: Vitest (`vi.mock()` for module mocking), Playwright
**Target Platform**: Docker containers (Linux), modern browsers
**Project Type**: Web application (SvelteKit full-stack)

**Performance Goals**:
- Session creation < 100ms
- Event throughput maintained
- Memory footprint increase < 10%

**Constraints**:
- **Simplicity First**: No DI frameworks (Awilix, InversifyJS, custom containers)
- **Native Patterns**: ES6 modules + Svelte context only
- Big Bang deployment
- No database schema breaking changes
- Per-request transaction boundaries

**Scale/Scope**:
- 12 architectural components (no DependencyContainer!)
- 37 functional + 14 non-functional requirements
- Refactoring 5 core subsystems

## Constitution Check

✅ **All principles validated**:

### I. Simplicity & Maintainability ✅

**Perfect Alignment**:
- **No frameworks**: Using native JavaScript ES6 modules
- **No abstractions**: Factory function instead of DI container (~50 lines vs ~200 lines)
- **YAGNI compliant**: Zero unused DI features
- **Explicit dependencies**: Visible in factory function, not hidden in container registration

### II-VI. Other Principles ✅

All other constitutional principles pass (same as before - single-user focus, event sourcing preserved, adapter pattern maintained, etc.)

**Key Improvement**: Previous plan violated simplicity by introducing custom DI container. New plan uses only native JavaScript/Svelte patterns.

## Project Structure

### Documentation

```
specs/007-design-pattern-refactor/
├── spec.md              # Feature specification (updated with simplicity requirement)
├── plan.md              # This file (simplified approach)
├── research.md          # Simplified patterns (NO DI framework research)
├── data-model.md        # Component specs (NO DependencyContainer class)
├── quickstart.md        # Verification steps
├── contracts/
│   ├── services.js      # Factory function contract (simplified)
│   ├── repositories.js  # Repository interfaces
│   ├── session-components.js
│   ├── socket-mediator.js
│   └── configuration.js
└── tasks.md             # Generated by /tasks command
```

### Source Code Structure

**Key File**: `src/lib/server/shared/services.js` - Central service initialization

```
src/lib/server/
├── shared/
│   ├── services.js           # NEW: Factory function (replaces globalServicesInstance)
│   └── index.js              # REFACTOR: Use services.js pattern
├── database/                 # NEW: Separated database layer
│   ├── DatabaseManager.js    # REFACTOR: Connection + migrations only
│   ├── SessionRepository.js  # NEW
│   ├── EventStore.js         # NEW
│   ├── SettingsRepository.js # NEW
│   └── WorkspaceRepository.js # NEW
├── sessions/                 # NEW: Decomposed session management
│   ├── AdapterRegistry.js
│   ├── EventRecorder.js
│   ├── SessionOrchestrator.js
│   └── adapters/             # Existing (minimal changes)
├── socket/                   # NEW: Organized socket handlers
│   ├── SocketEventMediator.js
│   ├── middleware/
│   │   ├── auth.js           # Middleware factory (uses JWTService)
│   │   └── errorHandling.js
│   └── handlers/
│       ├── sessionHandlers.js
│       ├── authHandlers.js
│       └── [other domains]
├── tunnels/
│   ├── BaseTunnelManager.js  # NEW: Abstract class
│   ├── TunnelManager.js      # REFACTOR: Extend base
│   └── VSCodeTunnelManager.js # REFACTOR: Extend base
└── auth/
    ├── JWTService.js         # NEW
    └── AuthService.js        # REFACTOR: Use JWT

src/routes/
└── +layout.svelte            # UPDATE: Use setContext for client services
```

## Phase 0: Research ✅

Created `research.md` with simplified decisions:

1. **Server DI**: ES6 module exports + factory function (NO framework)
2. **Client DI**: Svelte `setContext`/`getContext` (native API)
3. **Repositories**: Direct SQL + ES6 classes
4. **Transactions**: Middleware wrapper
5. **JWT**: jsonwebtoken library
6. **Socket.IO**: Middleware + handlers

**Key Decision**: Rejected all DI frameworks in favor of ~50-line factory function.

## Phase 1: Design ✅

### Data Model

Created `data-model.md` with 12 components (removed DependencyContainer):

1. **ServiceRegistry Module** (services.js) - Factory function, NOT a class
2. SessionRepository
3. EventStore
4. SettingsRepository
5. WorkspaceRepository
6. AdapterRegistry
7. EventRecorder
8. SessionOrchestrator
9. SocketEventMediator
10. BaseTunnelManager
11. ConfigurationService
12. Auth/Error Middleware (functions)

**Simplified Pattern**:
```javascript
export function createServices(config) {
  const db = new DatabaseManager(config);
  const sessionRepo = new SessionRepository(db);
  const eventStore = new EventStore(db);
  // ... explicit wiring
  return { db, sessionRepo, eventStore, ... };
}

export let services; // Singleton for app
export function initializeServices(config) {
  services = createServices(config);
}
```

### Contracts

Created JSDoc contracts in `contracts/`:
- `services.js` - Factory function and Services object type
- `repositories.js` - Repository interfaces
- `session-components.js` - Orchestrator/recorder interfaces
- `socket-mediator.js` - Mediator and middleware interfaces
- `configuration.js` - Config and JWT interfaces

### Quickstart

`quickstart.md` includes 7 verification steps (updated for simplified approach):
1. Verify service initialization (check `createServices` logs)
2. Verify repository separation
3. Verify Socket.IO organization
4. Verify tunnel abstraction
5. Verify JWT authentication
6. Verify error handling
7. Verify performance

### CLAUDE.md Update

✅ Updated via `.specify/scripts/bash/update-agent-context.sh claude`

## Phase 2: Task Generation Approach

**Task Strategy** (for `/tasks` command):

### Phase A: Core Infrastructure (Parallel)
1. Create ConfigurationService
2. Create JWTService
3. Refactor DatabaseManager (connection + migrations only)

### Phase B: Repositories (Parallel after A)
4. Create SessionRepository
5. Create EventStore
6. Create SettingsRepository
7. Create WorkspaceRepository

### Phase C: Session Components (Sequential)
8. Create AdapterRegistry
9. Create EventRecorder (depends on EventStore)
10. Create SessionOrchestrator (depends on repositories + recorder)

### Phase D: Socket/Tunnel (Parallel)
11. Create auth middleware factory
12. Create error handling middleware
13. Create SocketEventMediator
14. Create domain socket handlers
15. Create BaseTunnelManager
16. Refactor TunnelManager (extend base)
17. Refactor VSCodeTunnelManager (extend base)

### Phase E: Integration (Sequential)
18. Create `services.js` factory function
19. Refactor `shared/index.js` to use `initializeServices()`
20. Update API routes to import from `services`
21. Add transaction middleware to hooks.server.js
22. Update client +layout.svelte with setContext

### Phase F: Testing
23-30. Unit tests for each new component
31-35. Integration tests (DI wiring, transactions, auth flow, etc.)
36-40. E2E tests (no regressions)

**Estimated**: 40 tasks, 2-4 hours each

## Complexity Tracking

**NO VIOLATIONS** ✅

Previous plan had potential violation: Custom DI container added complexity.

**This plan**: Uses only native patterns (ES6 exports, Svelte context). **Simpler than previous plan**.

| Previous Concern | Resolution |
|-----------------|------------|
| DI Container complexity | ❌ **Removed** - using factory function instead |
| Repository pattern | ✅ Justified - SOLID Single Responsibility |
| Socket mediator | ✅ Justified - organizes 100+ line file |
| Base tunnel class | ✅ Justified - DRY principle |
| JWT dependency | ✅ Required by spec (FR-025) |

## Progress Tracking

**Phase Status**:
- [x] Phase 0: Research complete ✅ research.md (simplified, no DI framework)
- [x] Phase 1: Design complete ✅ data-model.md (no DependencyContainer), contracts/, quickstart.md, CLAUDE.md
- [x] Phase 2: Task planning approach ✅ Described above (40 tasks)
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation
- [ ] Phase 5: Validation

**Gate Status**:
- [x] Initial Constitution Check: PASS ✅
- [x] Post-Design Constitution Check: PASS ✅ (Improved - simpler than before!)
- [x] All NEEDS CLARIFICATION resolved ✅
- [x] Complexity deviations: NONE ✅ (removed DI container)

**Artifacts Generated**:
- ✅ `plan.md` - This simplified plan
- ✅ `research.md` - Native pattern decisions (no frameworks)
- ✅ `data-model.md` - 12 components (no DI container class)
- ✅ `contracts/` - JSDoc interfaces (5 files)
- ✅ `quickstart.md` - 7 verification steps
- ✅ `CLAUDE.md` - Updated context

---

## Key Improvements Over Previous Plan

1. **Removed DI Container** (~200 lines) → Factory function (~50 lines)
2. **Zero new frameworks** → Native JavaScript only
3. **Simpler testing** → `vi.mock()` instead of container test mode
4. **Explicit dependencies** → Visible in factory function
5. **Constitutional alignment** → Perfect simplicity compliance

**Ready for `/tasks` command** to generate implementation tasks following this simplified architecture.

---

_Based on Constitution v1.3.0 - Prioritizing Simplicity & YAGNI_
